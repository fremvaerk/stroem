name: Release

on:
  push:
    tags: ["v*"]

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  build-binaries:
    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-amd64
            runner: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            use_cross: false
          # - name: linux-arm64
          #   runner: ubuntu-latest
          #   target: aarch64-unknown-linux-gnu
          #   use_cross: true
          # - name: darwin-amd64
          #   runner: macos-13
          #   target: x86_64-apple-darwin
          #   use_cross: false
          # - name: darwin-arm64
          #   runner: macos-14
          #   target: aarch64-apple-darwin
          #   use_cross: false
          # - name: windows-amd64
          #   runner: windows-latest
          #   target: x86_64-pc-windows-msvc
          #   use_cross: false
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: release-${{ matrix.target }}

      - name: Install cross
        if: matrix.use_cross
        run: cargo install cross --locked

      # Build frontend (rust-embed needs static/ populated)
      - uses: oven-sh/setup-bun@v2

      - name: Build frontend
        working-directory: ui
        run: bun install --frozen-lockfile && bun run build

      # Build all three binaries
      - name: Build stroem-server
        run: ${{ matrix.use_cross && 'cross' || 'cargo' }} build --release --target ${{ matrix.target }} -p stroem-server

      - name: Build stroem-worker
        run: ${{ matrix.use_cross && 'cross' || 'cargo' }} build --release --target ${{ matrix.target }} -p stroem-worker

      - name: Build stroem-cli
        run: ${{ matrix.use_cross && 'cross' || 'cargo' }} build --release --target ${{ matrix.target }} -p stroem-cli

      # Package archives
      - name: Package (unix)
        if: runner.os != 'Windows'
        run: |
          for bin in stroem-server stroem-worker stroem-cli; do
            tar czf "${bin}-${{ matrix.target }}.tar.gz" \
              -C target/${{ matrix.target }}/release "${bin}"
          done

      - name: Package (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          foreach ($bin in @("stroem-server", "stroem-worker", "stroem-cli")) {
            Compress-Archive `
              -Path "target/${{ matrix.target }}/release/${bin}.exe" `
              -DestinationPath "${bin}-${{ matrix.target }}.zip"
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.name }}
          path: |
            stroem-*-${{ matrix.target }}.tar.gz
            stroem-*-${{ matrix.target }}.zip
          if-no-files-found: error

  build-server:
    name: Build Server Image
    runs-on: ubuntu-latest
    needs: [build-binaries]
    steps:
      - uses: actions/checkout@v4

      - name: Download linux-amd64 binary
        uses: actions/download-artifact@v4
        with:
          name: binaries-linux-amd64
          path: artifacts/

      # - name: Download linux-arm64 binary
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: binaries-linux-arm64
      #     path: artifacts/

      - name: Prepare binaries for Docker build
        run: |
          mkdir -p dist
          tar xzf artifacts/stroem-server-x86_64-unknown-linux-gnu.tar.gz -C dist
          mv dist/stroem-server dist/stroem-server-linux-amd64
          # tar xzf artifacts/stroem-server-aarch64-unknown-linux-gnu.tar.gz -C dist
          # mv dist/stroem-server dist/stroem-server-linux-arm64

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/stroem-server
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}

      - uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.server.release
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  build-worker:
    name: Build Worker Image
    runs-on: ubuntu-latest
    needs: [build-binaries]
    steps:
      - uses: actions/checkout@v4

      - name: Download linux-amd64 binary
        uses: actions/download-artifact@v4
        with:
          name: binaries-linux-amd64
          path: artifacts/

      # - name: Download linux-arm64 binary
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: binaries-linux-arm64
      #     path: artifacts/

      - name: Prepare binaries for Docker build
        run: |
          mkdir -p dist
          tar xzf artifacts/stroem-worker-x86_64-unknown-linux-gnu.tar.gz -C dist
          mv dist/stroem-worker dist/stroem-worker-linux-amd64
          # tar xzf artifacts/stroem-worker-aarch64-unknown-linux-gnu.tar.gz -C dist
          # mv dist/stroem-worker dist/stroem-worker-linux-arm64

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/stroem-worker
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}

      - uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.worker.release
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  build-runner:
    name: Build Runner Image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/stroem-runner
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}

      - uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.runner
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=runner
          cache-to: type=gha,mode=max,scope=runner

  helm:
    name: Publish Helm Chart
    runs-on: ubuntu-latest
    needs: [build-server, build-worker]
    steps:
      - uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Determine version
        id: versions
        run: |
          # v1.2.3 â†’ 1.2.3
          CHART_VERSION="${GITHUB_REF_NAME#v}"
          APP_VERSION="${CHART_VERSION}"
          echo "chart_version=${CHART_VERSION}" >> "$GITHUB_OUTPUT"
          echo "app_version=${APP_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Update Chart.yaml versions
        run: |
          sed -i "s/^version:.*/version: ${{ steps.versions.outputs.chart_version }}/" helm/stroem/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ steps.versions.outputs.app_version }}\"/" helm/stroem/Chart.yaml
          cat helm/stroem/Chart.yaml

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Package chart
        run: helm package ./helm/stroem

      - name: Push chart
        run: helm push stroem-${{ steps.versions.outputs.chart_version }}.tgz oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-binaries, build-server, build-worker, build-runner, helm]
    steps:
      - uses: actions/checkout@v4

      - name: Download all binary artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: binaries-*
          merge-multiple: true
          path: release-assets/

      - uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: release-assets/*
